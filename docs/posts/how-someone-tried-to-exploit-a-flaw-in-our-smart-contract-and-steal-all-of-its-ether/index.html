<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>CityMayor  | How Someone Tried to Exploit a Flaw in Our Smart Contract and Steal All of Its Ether</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.50" />
    
    
      <META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
    

    <link href='https://blog.citymayor.co/dist/main.css' rel='stylesheet' type="text/css" />
    
      
    

    
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>

    <meta property="og:title" content="How Someone Tried to Exploit a Flaw in Our Smart Contract and Steal All of Its Ether" />
<meta property="og:description" content="On March 7th, we noticed some weird transactions happening on CityMayor. First, someone used our contract directly instead of going through the dAPP. We know that, because a nickname is mandatory if you want to use the DAPP to interact with the CityMayor contract.
Now, don&rsquo;t get me wrong, that&rsquo;s pretty neat! We are not against people using the contract directly, and we actually encourage you to do so :) We&rsquo;ve extensively documented the smart contract on etherscan." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.citymayor.co/posts/how-someone-tried-to-exploit-a-flaw-in-our-smart-contract-and-steal-all-of-its-ether/" /><meta property="article:published_time" content="2018-03-08T16:47:00&#43;00:00"/>
<meta property="article:modified_time" content="2018-03-08T16:47:00&#43;00:00"/>

<meta itemprop="name" content="How Someone Tried to Exploit a Flaw in Our Smart Contract and Steal All of Its Ether">
<meta itemprop="description" content="On March 7th, we noticed some weird transactions happening on CityMayor. First, someone used our contract directly instead of going through the dAPP. We know that, because a nickname is mandatory if you want to use the DAPP to interact with the CityMayor contract.
Now, don&rsquo;t get me wrong, that&rsquo;s pretty neat! We are not against people using the contract directly, and we actually encourage you to do so :) We&rsquo;ve extensively documented the smart contract on etherscan.">


<meta itemprop="datePublished" content="2018-03-08T16:47:00&#43;00:00" />
<meta itemprop="dateModified" content="2018-03-08T16:47:00&#43;00:00" />
<meta itemprop="wordCount" content="981">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How Someone Tried to Exploit a Flaw in Our Smart Contract and Steal All of Its Ether"/>
<meta name="twitter:description" content="On March 7th, we noticed some weird transactions happening on CityMayor. First, someone used our contract directly instead of going through the dAPP. We know that, because a nickname is mandatory if you want to use the DAPP to interact with the CityMayor contract.
Now, don&rsquo;t get me wrong, that&rsquo;s pretty neat! We are not against people using the contract directly, and we actually encourage you to do so :) We&rsquo;ve extensively documented the smart contract on etherscan."/>

      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-106516-14', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
  </head>

  <body class="ma0 avenir bg-near-white production">

    

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation" style="background-color: #333;padding:8px 20px;">
  <div class="flex-l justify-between items-center center">
    <a href="https://blog.citymayor.co" class="f3 fw2 hover-white no-underline white-90 dib">
      <img src="https://citymayor.co/static/assets/img/logo_long_no_bg.png" width="170px">
    </a>
    <div class="flex-l items-center">
      
        <ul class="pl0 mr3" style="margin:0;">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="https://www.citymayor.co" title="back to CityMayor.co page" style="font-size:17px">
              back to CityMayor.co
            </a>
          </li>
          
        </ul>
      
      








    </div>
  </div>
</nav>

    </div>
  </header>


    <main class="pb7" role="main">
      
  <div class="flex-l mt2 mw8 center">
    <article class="center cf pv5 ph3 ph4-ns mw7">
      <header>
        <h1 class="f1">
          How Someone Tried to Exploit a Flaw in Our Smart Contract and Steal All of Its Ether
        </h1>
      </header>
      <div class="nested-copy-line-height lh-copy f4 nested-links nested-img mid-gray">
        <p>On March 7th, we noticed some weird transactions happening on <a href="ttps://www.citymayor.co"><strong>CityMayor</strong></a>. First, someone used our contract directly instead of going through the <a href="https://www.citymayor.co">dAPP</a>. We know that, because a nickname is mandatory if you want to use the DAPP to interact with the CityMayor contract.</p>

<p><img src="/img/hack/direct_tx.png" alt="direct transaction" /></p>

<p>Now, don&rsquo;t get me wrong, that&rsquo;s pretty neat! We are not against people using the contract directly, and we actually encourage you to do so :) <a href="https://etherscan.io/address/0x4bdde1e9fbaef2579dd63e2abbf0be445ab93f10#code">We&rsquo;ve extensively documented the smart contract on etherscan.io</a> so that anyone can take a look at it (it&rsquo;s pretty short), try to understand it and interact with it directly.</p>

<p><img src="/img/hack/weird_tx.png" alt="weird transactions" /></p>

<p>The weird transactions can be observed in the <a href="https://etherscan.io/address/0x4bdde1e9fbaef2579dd63e2abbf0be445ab93f10#internaltx">&ldquo;Internal Transactions&rdquo; tab of the CityMayor contract</a>. The highlighted address is CityMayor&rsquo;s smart contract.</p>

<p>Why are these &ldquo;<em>internal</em>&rdquo; transactions? Because these transactions happened as part of the execution of something else! Looking at <a href="https://etherscan.io/address/0x6fb62bec140218ff7c43b20232e06a05f9b25253">0x6fb62bec140218ff7c43b20232e06a05f9b25253</a> we can see that <strong>a smart contract is calling CityMayor</strong>, not a normal Ethereum user!</p>

<p><img src="/img/hack/contract_malicious.png" alt="contract" /></p>

<p>We can see that the smart contract has been deployed especially for interacting with CityMayor, and that it was later <strong>killed</strong>. Fortunately everything is in clear on the blockchain and we managed to recover the bytecode of the malicious contract. The contract code can then be reversed engineer with a decompiler like <a href="https://github.com/comaeio/porosity">porosity</a> or other reverse engineering tools. Unfortunately we have to do this because our attacker did not publish the Solidity source code, but this would be for another blog post.</p>

<p><img src="/img/hack/bytecode.png" alt="bytecode" /></p>

<p>We will just use <a href="https://etherscan.io/address/0x6fb62bec140218ff7c43b20232e06a05f9b25253">Etherscan</a> to analyze what our mysterious user called on his malicious contract:</p>

<p><strong>1.</strong> <a href="https://etherscan.io/tx/0x2f8bb00e207b5d5433d4cc3b3a6581950eb6f1a97112ef20f7a9624b81e531e0">the first one</a> uses <code>setContract(address _ownerContract)</code> with the address of our contract.</p>

<blockquote>
<p>Note that in reality, we can&rsquo;t see the protype of the function called, but only its signature (<code>0x75f890ab</code>) and its input. This is because we don&rsquo;t have access to the contract&rsquo;s ABI or source code. How does Etherscan shows us the prototype of the function called then? Etherscan must have a table of known function prototypes and their associated signature. This way, Etherscan knows (by having learned it previously, somehow) that <code>setContract(address _ownerContract)</code> is associated to <code>0x75f890ab</code>.</p>
</blockquote>

<p><strong>2.</strong> <a href="https://etherscan.io/tx/0x11101f12a900eb0470e2751abba0cc86ac1d7067fdbc56ab159973fca3f61c7d#internal">the second transaction</a> executes the function with signature <code>be4d6211</code> (Etherscan doesn&rsquo;t seem to know the prototype for that one) and sends it 0.25 ETH. The execution seems to trigger the execution of the CityMayor contract (we can see that in the &ldquo;internal transaction&rdquo; tab again) and sends it the attacker&rsquo;s 0.25 ETH. We detect that an offer has been made, so we guess that the attacker has used his or her contract to make an indirect offer to buy a city (Moscow).</p>

<p><img src="/img/hack/interaction.png" alt="interaction" /></p>

<p><strong>3.</strong> the third transaction calls the function <code>fc64b60b</code> with input <code>0x17</code>. No idea what that is doing.</p>

<p><strong>4.</strong> <a href="https://etherscan.io/tx/0xf7001b009387d4f1cb4a609978ee78d86d9af3ae28f1146c10ee02ffcd20bba7">the fourth transaction</a> is the interesting one! Our attacker calls the <code>getFunds()</code> function of his/her malicious contract, which seems to trigger the <code>cancelOfferForCity()</code> function of CityMayor. You guessed it right, he or she is trying to cancel his or her offer. But what happens next? CityMayor reimburses the attacker&rsquo;s contract by sending it the 0.25 ETH but the transaction fails. Odd right?</p>

<p>What exactly happened? Let&rsquo;s take a look at our <code>cancelOfferForCity()</code> function:</p>

<p><img src="/img/hack/better_code.png" alt="code" /></p>

<p>What it does is pretty straight forward:</p>

<ol>
<li>it gets the offer via the offer ID.</li>
<li>it checks if the caller is indeed the one who made the offer</li>
<li>it refunds the caller via the <code>msg.sender.transfer()</code> function</li>
<li>it deletes the offer</li>
<li>it emits an event that we can detect to update our dapp</li>
</ol>

<p>What is the attacker trying to do here? Well, what the attacker has seen in this code, is what we call a <strong>reentrancy vulnerability</strong>.</p>

<p>When <code>msg.sender.transfer()</code> is called to send money to the <code>msg.sender</code> address, <strong>if the receiving address is a smart contract</strong> (which is what is actually happening here) and if it has a <strong>fallback function</strong>, then it will be executed. A fallback function is an &ldquo;<em>everything-goes-in</em>&rdquo; kind of function that will be executed if no method is explicitely called (our case since we&rsquo;re just sending some ETH to the contract) or if the method called doesn&rsquo;t exist. It looks like this:</p>

<pre><code class="language-js">function () payable {
    // do something...
}
</code></pre>

<p>Wait what? That means that the third line of our function, which refunds the caller, is <strong>leading to the code execution of another contract</strong>? Yup you heard it right. That&rsquo;s a surprising artifact of smart contracts and of how the Ethereum VM (EVM) behaves! Interesting right?</p>

<p><img src="/img/hack/code.png" alt="code" /></p>

<p>What&rsquo;s even more interesting, is that this fallback function could call the CityMayor contract again. Like this:</p>

<p><img src="/img/hack/diagram.png" alt="diagram" /></p>

<p>At this point what&rsquo;s happening is <strong>basic nested call 101</strong>, but what our attacker saw is that if this works: the second execution of <code>cancelOfferForCity()</code> will still be valid since the offer still hasn&rsquo;t been deleted in the first execution of <code>cancelOfferForCity()</code>.</p>

<p>The second execution will lead to a second execution of <code>msg.sender.transfer()</code>, which would allow our attacker to cancel his or her offer twice and to <strong>double the amount money</strong> that he or she initially put in!</p>

<p>Why didn&rsquo;t it work then? Well, unfortunately for our attacker, this attack doesn&rsquo;t work with the <code>transfer()</code> function CityMayor uses. Why? Because <code>transfer()</code> limits the amount of <strong>gas</strong> that the nested call will be able to use. Gas is an important concept in Ethereum, each instruction consumes some gas and each transaction needs some amount of gas to run to its full completion. <code>transfer()</code> limits the amount of gas of the following transaction, it makes sense right? it is meant to transfer money, not execute code. If CityMayor&rsquo;s code had used a low level call instead, like <code>call()</code> which doesn&rsquo;t limit gas in the same way, the attack would probably have worked.</p>

<p>By the way, if you&rsquo;ve heard of <a href="https://www.coindesk.com/understanding-dao-hack-journalists/">the DAO</a> attack, this is basically the same thing.</p>

<p>Good job to our mysterious attacker <a href="https://etherscan.io/address/0xafc64ad0eb7283ebfc9b9f706c914b633e1a78c3">0xafc64ad0eb7283ebfc9b9f706c914b633e1a78c3</a>! We&rsquo;ve sent him or her 10,000 CITYs (the token of CityMayor) for the effort and for motivating this blog post :)</p>

<p><i class="fas fa-university"></i> <strong>The United Nations</strong></p>

      </div>



        
        <style type="text/css">
          #mc_embed_signup{background:#fff; clear:left; padding: 10px 40px;}
        </style>
        <div id="mc_embed_signup">
          <h2>Building an Ethereum / EOS / Bitcoin dApp? </h2>
          <p>
            <strong><a href="https://nodablock.com">Nodablock</a></strong> helps Citymayor to access the Ethereum network without any hassle
          </p>

            <p>
                <strong>Nodablock</strong> provides an easy access to the main Blockchain networks (Ethereum, EOS, bitcoin) with a secure, 
                reliable, and scalable API. It saves developers time and money, and remove the need to maintain your own node.
          </p>
        </div>

      </article>
  </div>

  

    </main>
    <footer class="bg-near-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://blog.citymayor.co" >
    &copy; 2018 CityMayor
  </a>
  








  </div>
</footer>

    <script src="https://blog.citymayor.co/dist/app.bundle.js" async></script>

  </body>
</html>
